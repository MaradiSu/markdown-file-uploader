import insertText from '../../utils/InsertTextAtPosition';
import { TextAreaTextApi } from '../../commands';
import { insertBeforeEachLine } from '../../commands/list';
/**
 * - `13` - `Enter`
 * - `9` - `Tab`
 */

function stopPropagation(e) {
  e.stopPropagation();
  e.preventDefault();
}

export default function handleKeyDown(e) {
  var tabSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 2;
  var target = e.target;
  var starVal = target.value.substr(0, target.selectionStart);
  var valArr = starVal.split('\n');
  var currentLineStr = valArr[valArr.length - 1];
  var textArea = new TextAreaTextApi(target);
  /**
   * `9` - `Tab`
   */

  if (e.code && e.code.toLowerCase() === 'tab') {
    stopPropagation(e);
    var space = new Array(tabSize + 1).join('  ');

    if (target.selectionStart !== target.selectionEnd) {
      var _star = target.value.substring(0, target.selectionStart).split('\n');

      var _end = target.value.substring(0, target.selectionEnd).split('\n');

      var modifiedTextLine = [];

      _end.forEach(function (item, idx) {
        if (item !== _star[idx]) {
          modifiedTextLine.push(item);
        }
      });

      var modifiedText = modifiedTextLine.join('\n');
      var oldSelectText = target.value.substring(target.selectionStart, target.selectionEnd);
      var newStarNum = target.value.substring(0, target.selectionStart).length;
      textArea.setSelectionRange({
        start: target.value.indexOf(modifiedText),
        end: target.selectionEnd
      });
      var modifiedTextObj = insertBeforeEachLine(modifiedText, e.shiftKey ? '' : space);
      var text = modifiedTextObj.modifiedText;

      if (e.shiftKey) {
        text = text.split('\n').map(function (item) {
          return item.replace(new RegExp("^".concat(space)), '');
        }).join('\n');
      }

      textArea.replaceSelection(text);
      var startTabSize = e.shiftKey ? -tabSize : tabSize;
      var endTabSize = e.shiftKey ? -modifiedTextLine.length * tabSize : modifiedTextLine.length * tabSize;
      textArea.setSelectionRange({
        start: newStarNum + startTabSize,
        end: newStarNum + oldSelectText.length + endTabSize
      });
    } else {
      return insertText(target, space);
    }
  } else if (e.code && e.code.toLowerCase() === 'enter' && (/^(-|\*)\s/.test(currentLineStr) || /^\d+.\s/.test(currentLineStr))) {
    /**
     * `13` - `Enter`
     */
    stopPropagation(e);
    var startStr = '\n- ';

    if (currentLineStr.startsWith('*')) {
      startStr = '\n* ';
    }

    if (/^\d+.\s/.test(currentLineStr)) {
      startStr = "\n".concat(parseInt(currentLineStr) + 1, ". ");
    }

    return insertText(target, startStr);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1RleHRBcmVhL2hhbmRsZUtleURvd24udHN4Il0sIm5hbWVzIjpbImluc2VydFRleHQiLCJUZXh0QXJlYVRleHRBcGkiLCJpbnNlcnRCZWZvcmVFYWNoTGluZSIsInN0b3BQcm9wYWdhdGlvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImhhbmRsZUtleURvd24iLCJ0YWJTaXplIiwidGFyZ2V0Iiwic3RhclZhbCIsInZhbHVlIiwic3Vic3RyIiwic2VsZWN0aW9uU3RhcnQiLCJ2YWxBcnIiLCJzcGxpdCIsImN1cnJlbnRMaW5lU3RyIiwibGVuZ3RoIiwidGV4dEFyZWEiLCJjb2RlIiwidG9Mb3dlckNhc2UiLCJzcGFjZSIsIkFycmF5Iiwiam9pbiIsInNlbGVjdGlvbkVuZCIsIl9zdGFyIiwic3Vic3RyaW5nIiwiX2VuZCIsIm1vZGlmaWVkVGV4dExpbmUiLCJmb3JFYWNoIiwiaXRlbSIsImlkeCIsInB1c2giLCJtb2RpZmllZFRleHQiLCJvbGRTZWxlY3RUZXh0IiwibmV3U3Rhck51bSIsInNldFNlbGVjdGlvblJhbmdlIiwic3RhcnQiLCJpbmRleE9mIiwiZW5kIiwibW9kaWZpZWRUZXh0T2JqIiwic2hpZnRLZXkiLCJ0ZXh0IiwibWFwIiwicmVwbGFjZSIsIlJlZ0V4cCIsInJlcGxhY2VTZWxlY3Rpb24iLCJzdGFydFRhYlNpemUiLCJlbmRUYWJTaXplIiwidGVzdCIsInN0YXJ0U3RyIiwic3RhcnRzV2l0aCIsInBhcnNlSW50Il0sIm1hcHBpbmdzIjoiQUFBQSxPQUFPQSxVQUFQLE1BQXVCLGtDQUF2QjtBQUNBLFNBQVNDLGVBQVQsUUFBZ0MsZ0JBQWhDO0FBQ0EsU0FBU0Msb0JBQVQsUUFBcUMscUJBQXJDO0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBQ0EsU0FBU0MsZUFBVCxDQUF5QkMsQ0FBekIsRUFBc0U7QUFDcEVBLEVBQUFBLENBQUMsQ0FBQ0QsZUFBRjtBQUNBQyxFQUFBQSxDQUFDLENBQUNDLGNB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b0M7QUFDbENrQyxNQUFBQSxRQUFRLGVBQVFFLFFBQVEsQ0FBQ3BDLGNBQUQsQ0FBUixHQUEyQixDQUFuQyxPQUFSO0FBQ0Q7O0FBQ0QsV0FBT2YsVUFBVSxDQUFDUSxNQUFELEVBQVN5QyxRQUFULENBQWpCO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBpbnNlcnRUZXh0IGZyb20gJy4uLy4uL3V0aWxzL0luc2VydFRleHRBdFBvc2l0aW9uJztcclxuaW1wb3J0IHsgVGV4dEFyZWFUZXh0QXBpIH0gZnJvbSAnLi4vLi4vY29tbWFuZHMnO1xyXG5pbXBvcnQgeyBpbnNlcnRCZWZvcmVFYWNoTGluZSB9IGZyb20gJy4uLy4uL2NvbW1hbmRzL2xpc3QnO1xyXG5cclxuLyoqXHJcbiAqIC0gYDEzYCAtIGBFbnRlcmBcclxuICogLSBgOWAgLSBgVGFiYFxyXG4gKi9cclxuZnVuY3Rpb24gc3RvcFByb3BhZ2F0aW9uKGU6IFJlYWN0LktleWJvYXJkRXZlbnQ8SFRNTFRleHRBcmVhRWxlbWVudD4pIHtcclxuICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gIGUucHJldmVudERlZmF1bHQoKTtcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gaGFuZGxlS2V5RG93bihlOiBSZWFjdC5LZXlib2FyZEV2ZW50PEhUTUxUZXh0QXJlYUVsZW1lbnQ+LCB0YWJTaXplOiBudW1iZXIgPSAyKSB7XHJcbiAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQgYXMgSFRNTFRleHRBcmVhRWxlbWVudDtcclxuICBjb25zdCBzdGFyVmFsID0gdGFyZ2V0LnZhbHVlLnN1YnN0cigwLCB0YXJnZXQuc2VsZWN0aW9uU3RhcnQpO1xyXG4gIGNvbnN0IHZhbEFyciA9IHN0YXJWYWwuc3BsaXQoJ1xcbicpO1xyXG4gIGNvbnN0IGN1cnJlbnRMaW5lU3RyID0gdmFsQXJyW3ZhbEFyci5sZW5ndGggLSAxXTtcclxuICBjb25zdCB0ZXh0QXJlYSA9IG5ldyBUZXh0QXJlYVRleHRBcGkodGFyZ2V0KTtcclxuICAvKipcclxuICAgKiBgOWAgLSBgVGFiYFxyXG4gICAqL1xyXG4gIGlmIChlLmNvZGUgJiYgZS5jb2RlLnRvTG93ZXJDYXNlKCkgPT09ICd0YWInKSB7XHJcbiAgICBzdG9wUHJvcGFnYXRpb24oZSk7XHJcbiAgICBjb25zdCBzcGFjZSA9IG5ldyBBcnJheSh0YWJTaXplICsgMSkuam9pbignICAnKTtcclxuICAgIGlmICh0YXJnZXQuc2VsZWN0aW9uU3RhcnQgIT09IHRhcmdldC5zZWxlY3Rpb25FbmQpIHtcclxuICAgICAgY29uc3QgX3N0YXIgPSB0YXJnZXQudmFsdWUuc3Vic3RyaW5nKDAsIHRhcmdldC5zZWxlY3Rpb25TdGFydCkuc3BsaXQoJ1xcbicpO1xyXG4gICAgICBjb25zdCBfZW5kID0gdGFyZ2V0LnZhbHVlLnN1YnN0cmluZygwLCB0YXJnZXQuc2VsZWN0aW9uRW5kKS5zcGxpdCgnXFxuJyk7XHJcbiAgICAgIGNvbnN0IG1vZGlmaWVkVGV4dExpbmU6IHN0cmluZ1tdID0gW107XHJcbiAgICAgIF9lbmQuZm9yRWFjaCgoaXRlbSwgaWR4KSA9PiB7XHJcbiAgICAgICAgaWYgKGl0ZW0gIT09IF9zdGFyW2lkeF0pIHtcclxuICAgICAgICAgIG1vZGlmaWVkVGV4dExpbmUucHVzaChpdGVtKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zdCBtb2RpZmllZFRleHQgPSBtb2RpZmllZFRleHRMaW5lLmpvaW4oJ1xcbicpO1xyXG4gICAgICBjb25zdCBvbGRTZWxlY3RUZXh0ID0gdGFyZ2V0LnZhbHVlLnN1YnN0cmluZyh0YXJnZXQuc2VsZWN0aW9uU3RhcnQsIHRhcmdldC5zZWxlY3Rpb25FbmQpO1xyXG4gICAgICBjb25zdCBuZXdTdGFyTnVtID0gdGFyZ2V0LnZhbHVlLnN1YnN0cmluZygwLCB0YXJnZXQuc2VsZWN0aW9uU3RhcnQpLmxlbmd0aDtcclxuXHJcbiAgICAgIHRleHRBcmVhLnNldFNlbGVjdGlvblJhbmdlKHtcclxuICAgICAgICBzdGFydDogdGFyZ2V0LnZhbHVlLmluZGV4T2YobW9kaWZpZWRUZXh0KSxcclxuICAgICAgICBlbmQ6IHRhcmdldC5zZWxlY3Rpb25FbmQsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgbW9kaWZpZWRUZXh0T2JqID0gaW5zZXJ0QmVmb3JlRWFjaExpbmUobW9kaWZpZWRUZXh0LCBlLnNoaWZ0S2V5ID8gJycgOiBzcGFjZSk7XHJcblxyXG4gICAgICBsZXQgdGV4dCA9IG1vZGlmaWVkVGV4dE9iai5tb2RpZmllZFRleHQ7XHJcbiAgICAgIGlmIChlLnNoaWZ0S2V5KSB7XHJcbiAgICAgICAgdGV4dCA9IHRleHRcclxuICAgICAgICAgIC5zcGxpdCgnXFxuJylcclxuICAgICAgICAgIC5tYXAoKGl0ZW0pID0+IGl0ZW0ucmVwbGFjZShuZXcgUmVnRXhwKGBeJHtzcGFjZX1gKSwgJycpKVxyXG4gICAgICAgICAgLmpvaW4oJ1xcbicpO1xyXG4gICAgICB9XHJcbiAgICAgIHRleHRBcmVhLnJlcGxhY2VTZWxlY3Rpb24odGV4dCk7XHJcblxyXG4gICAgICBsZXQgc3RhcnRUYWJTaXplID0gZS5zaGlmdEtleSA/IC10YWJTaXplIDogdGFiU2l6ZTtcclxuICAgICAgbGV0IGVuZFRhYlNpemUgPSBlLnNoaWZ0S2V5ID8gLW1vZGlmaWVkVGV4dExpbmUubGVuZ3RoICogdGFiU2l6ZSA6IG1vZGlmaWVkVGV4dExpbmUubGVuZ3RoICogdGFiU2l6ZTtcclxuXHJcbiAgICAgIHRleHRBcmVhLnNldFNlbGVjdGlvblJhbmdlKHtcclxuICAgICAgICBzdGFydDogbmV3U3Rhck51bSArIHN0YXJ0VGFiU2l6ZSxcclxuICAgICAgICBlbmQ6IG5ld1N0YXJOdW0gKyBvbGRTZWxlY3RUZXh0Lmxlbmd0aCArIGVuZFRhYlNpemUsXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGluc2VydFRleHQodGFyZ2V0LCBzcGFjZSk7XHJcbiAgICB9XHJcbiAgfSBlbHNlIGlmIChcclxuICAgIGUuY29kZSAmJlxyXG4gICAgZS5jb2RlLnRvTG93ZXJDYXNlKCkgPT09ICdlbnRlcicgJiZcclxuICAgICgvXigtfFxcKilcXHMvLnRlc3QoY3VycmVudExpbmVTdHIpIHx8IC9eXFxkKy5cXHMvLnRlc3QoY3VycmVudExpbmVTdHIpKVxyXG4gICkge1xyXG4gICAgLyoqXHJcbiAgICAgKiBgMTNgIC0gYEVudGVyYFxyXG4gICAgICovXHJcbiAgICBzdG9wUHJvcGFnYXRpb24oZSk7XHJcbiAgICBsZXQgc3RhcnRTdHIgPSAnXFxuLSAnO1xyXG4gICAgaWYgKGN1cnJlbnRMaW5lU3RyLnN0YXJ0c1dpdGgoJyonKSkge1xyXG4gICAgICBzdGFydFN0ciA9ICdcXG4qICc7XHJcbiAgICB9XHJcbiAgICBpZiAoL15cXGQrLlxccy8udGVzdChjdXJyZW50TGluZVN0cikpIHtcclxuICAgICAgc3RhcnRTdHIgPSBgXFxuJHtwYXJzZUludChjdXJyZW50TGluZVN0cikgKyAxfS4gYDtcclxuICAgIH1cclxuICAgIHJldHVybiBpbnNlcnRUZXh0KHRhcmdldCwgc3RhcnRTdHIpO1xyXG4gIH1cclxufVxyXG4iXX0=